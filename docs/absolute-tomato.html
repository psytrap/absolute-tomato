<!DOCTYPE html>
<html>
<head>
    <title>Absolute Tomato - The Pomodoro Timer</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QAAAAAAAD5Q7t/AAAFCUlEQVRYw+2WW2yUZRCGn/n+f9ttYUt3hVKopRQ5FQUkVORCglrRVEOMh4h4YUQ0xsRAMJiYeALjBSZeqMFENBoPMVFBEStUPIKoCGqg0FhIQdptXQpt7XbbPf//N15gjCagpXBleG9n5pv3e5N3ZuACLuD/gG3NDTrcWvdcGjfu+1g/72zgtW1vDfsNM9zCZ55epV/GdtKRStG1tf0fsUffqR+yIjLUxLWvL9aSzjCR30LUH9zMDzMi3HdFGenvRvL49sMsKUvQNGY2TfcIu3qESS0VbHj1VTlnAuvrb9VgOkVLRQaWdrPwzQSj2h32V0zgkZIRjNjZxupuD1MX5KfllmS0iK5XsizpFezsah5r3CLDJvDy/Dq9LZwmPM7l0x1Rnl9cyeSbu0n6QT7YNgVpj1O46yiDl1TD3HFUn+jjkp+iXBsdYOpUaLtMiH0srMv9esY+zpkCTy2o12XBASL3LyfX0orzTTtT9wxyMD6ZRLFHyYQTJL3f0cEMeTOeYLllQVUTdfOSlFzn88WcEfg1MKMBakxozS7tX3tWLri+JEXJzGlQWYkJlzJuuhI6kaH1cCvxO3PsKCgnV1pM4eUhbqo9xmcfjad1coR42UWA0nGojYXPFREnzaR/Efq0kTXXLNZHqwcJ3Hov7Pse2f4hvoVtg0WM3fAGK5uepnu74YamDiaEA+xeNo6pFa0EnhyJSpACtdASZ4xvGYUSEIeTTo6V+U4ZkgITU0kkXIY3sQbXOvj5Yg5u3MShNVme3fI807ckeLKnhzmjU1wkHm+vN2y+4zIufXgfi1YY5k9Lc9IqPQToIkC/OrhnEPu0ChwNlmn5HbVIqUvRCx9h237FvriOHxs/pTlnqS0QZs+ahF5Zh+zfTf7YPr7sDNAvwtWlPmHN0X1AOGldesWljQARxyUmWVbmo/KfCmjWI/HuHiK3T8fb+y1SXQ0PrOCKdILaBYtwNm7A3nIXTLkUiR6hoN1w/dgcvgeCEj8MooIVQxKhF0ME0NP897STMIGD5ymZn1sxax9CP3kPk0/B3LloKITOuwopKobGrZgDX2NzPl7SZ7BTSXQq+STEMaQ5RcACHqAiQ3PBAA6FgHQoI8NdmA/egeb9mIqLMVvfh0k1aMMmzMHdWEdIHvfwc0L2JHgqIJBQw4BAQgUr4CNYdGgEYgiuuuRzllCXB7+1Y5uj2GnTCca6KOrqIJfyyXRbcITscfCtkFYhhSGvgocQV8FHyCJYUXSoc+C72ZW4TTHG+9AZdQnjY1Wx7S1kiyEVMdi04Pc5ZNQiGMCQxmEAg4cQw5DEYVAcxogwIB6rc+1Ds+H6/XtlplSpj4NRj7QaQvgE8PFTSi5lMQi+CJ465AWsGHpxiSMMqCGNEBehH8N4UfrFP7t1PHbOxcQwtKhLHEM/AXwMORzSOCQxZNSgCH0EiKtLH4YedUhh6BZDrzpUClQ5AkbOfhk1yAT9RV3KxaccSxCLq/YvO/lAFsggZMSQUhcP6Ec4IS6jDdS6yjHJszzTJsNax59IlR5Sh0IUI+CiVGmetAj9CKqCRUgjZMVhACGlQrEI1xb4tOFzd7ZNzukgecKp3DpFAzcesafSS/ApQUlgMAgZgT4MRoW8KHWOgGO5KXtUzttF9FKwSmfh4qvhq5yPcspqFkGBMUaYH1AsysLMETnvJ9nfsT04UbGCCMif5hYjtKrHg9mo8L/HqqUrDRdwnvAHfVA3cCdaLX0AAAAASUVORK5CYII="/>


    <style>
    /* Colors according Tailwind CSS https://flowbite.com/docs/components/footer/ */
    /* TODO Slider */
        body {
            font-size: 150%;
            line-height: 1.5;
            font-family: Arial, sans-serif;
            max-width: 50rem;
            margin: auto;
            color: #e2e8f0;
            background-color: #0f172a; /* slate-900 */
        }
        button {
            font-size: 150%;
            padding: 1rem;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            background-color: #0ea5e9;
            color: #ffffff;
            border: .1rem solid #0ea5e9;
            border-radius: 1rem;
        }
        button:disabled, button[disabled] {        
            border: .1rem solid #4b5563;
            background-color: #334155;
            color: #9ca3af;  
        }

        table {
            margin-top: 1rem;
        }
        table, th, td {
          border: .1rem solid black;
          border-collapse: collapse;
          padding: .3rem;
          background-color: #1e293b;
          border-color: #353f4f;
        }
        .timerDiv {
            display: flex;
            justify-content: center;            
        }
        .timers {
            font-size: 150%;
            line-height: 2;            
        }
        input[type="range"] {
            height: 2rem;
        }
        a {
            color: #3b82f6;
        }
    </style>
</head>
<body>
    <h1>&#127813; Absolute Tomato</h1>
    <!--<p>The Minimalistic Pomodoro Timer</p>-->

    <div style="padding: 1rem; margin-bottom: 1rem;">
        <div class="timerDiv"><button id="startTimerButton" disabled>&#9658; Timer</button>&nbsp;&nbsp;&nbsp;<button id="stopTimerButton" disabled>&nbsp;&#9726;&#xfe0e;&nbsp;</button></div><!--  &#x25a0;&#x25b6; -->
        <div class="timerDiv timers"><p align="center">
            <span id="workTimer">0m00s</span>
            <br/>
            <span id="breakTimer">0m00s</span>
            </p>
        </div>
        <div class="timerDiv"><button id="workButton" disabled>Work</button>&nbsp;&nbsp;&nbsp;<button id="breakButton" disabled>Break</button></div>
    </div>

    <label for="workIntervalInput">Work interval:</label> <span id="workInterval">25</span>&nbsp;<label for="workIntervalInput">Minutes</label>
    <br>
    <input id="workIntervalInput" type="range" min="0" max="60" value="25" step="5" style="width: 100%">
    <br/>
    
    <label for="breakIntervalInput">Break interval:</label> <span id="breakInterval">5</span> <label for="breakIntervalInput">Minutes</label>
    <br/>
    <input id="breakIntervalInput" type="range" min="0" max="20" value="5" step="1" style="width: 100%">
    <br/>

    <label for="notificationIntervalInput">Notification repetition:</label> <span id="notificationInterval">10</span>&nbsp;<label for="notificationIntervalInput">Seconds</label>
    <br/>
    <input type="range" id="notificationIntervalInput" min="5" max="120" step="5" value="10" style="width: 100%">
    <br/>
    
    <label for="notificationVolumeInput">Notification volume:</label> <span id="notificationVolume">10</span>&nbsp;<label for="notificationVolumeInput">Percent</label>
    <br/>
    <input type="range" id="notificationVolumeInput" min="10" max="100" step="10" value="20" style="width: 100%">
    <br/>
    <small><a id="bookmark" href="">permalink</a></small>


    <table id="statistics" style="width: 100%;">
        <thead>
            <tr>
                <th>Time</th>
                <th>Work</th>
                <th>Break</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <hr style="color: #374151; margin-top: 2rem;">
    <small><p>This site is open source. Checkout <a href="https://github.com/psytrap/every-smart/tree/main/Readme.md">here</a>.</small>    
    <script type="text/javascript">
        const timer_states = {
            WORK: 'work',
            BREAK: 'break',
            OFF: 'off'
        };
        let timer_state = timer_states.OFF;
        let timer = setInterval(() => {
                console.log('tick');
                handleTick();
            }, 1000);
        let timer_seconds = 0;
        let timeout_seconds = 0;

        let work_interval_minutes = 0;
        let break_interval_minutes = 0;
        let notification_seconds = 0;
        let notification_volume = 0;
        let audioContext = null;
        
        const ID_WORK = "workInterval";
        const ID_WORK_INPUT = "workIntervalInput";        
        const ID_WORK_TIMER = "workTimer";
        const ID_BREAK = "breakInterval";        
        const ID_BREAK_INPUT = "breakIntervalInput";
        const ID_BREAK_TIMER = "breakTimer";
        const ID_NOTIFICATION = "notificationInterval";
        const ID_NOTIFICATION_INPUT = "notificationIntervalInput";        
        const ID_NOTIFICATION_VOLUME = "notificationVolume";
        const ID_NOTIFICATION_VOLUME_INPUT = "notificationVolumeInput";
        const ID_START_TIMER = "startTimerButton";        
        const ID_STOP_TIMER = "stopTimerButton";        
        const ID_TIMER_SWITCH = 'timerSwitch';
        const ID_BREAK_BUTTON = 'breakButton';        
        const ID_WORK_BUTTON = 'workButton';
        const ID_STATISTICS_TABLE = 'statistics';
        const ID_BOOKMARK = 'bookmark';
        
        document.addEventListener('DOMContentLoaded', function() {
            work_interval_minutes = document.getElementById(ID_WORK_INPUT).value;        
            break_interval_minutes = document.getElementById(ID_BREAK_INPUT).value;        
            notification_seconds = document.getElementById(ID_NOTIFICATION_INPUT).value;        
            notification_volume = document.getElementById(ID_NOTIFICATION_VOLUME_INPUT).value/100;
            document.getElementById(ID_WORK_INPUT).addEventListener('input', function() {
                work_interval_minutes = this.value;
                document.getElementById(ID_WORK).textContent = this.value;
                if ( timer_state !== timer_states.WORK) {
                    updateTimer(ID_WORK_TIMER, work_interval_minutes * 60);
                }
                updateBookmark();
            });
            document.getElementById(ID_BREAK_INPUT).addEventListener('input', function() {
                break_interval_minutes = this.value;
                document.getElementById(ID_BREAK).textContent = this.value;
                if ( timer_state !== timer_states.BREAK) {
                    updateTimer(ID_BREAK_TIMER, break_interval_minutes * 60);
                }
                updateBookmark();
            });
            document.getElementById(ID_NOTIFICATION_INPUT).addEventListener('input', function() {
                notification_seconds = this.value;
                document.getElementById(ID_NOTIFICATION).textContent = this.value;
                updateBookmark();
            });
            document.getElementById(ID_NOTIFICATION_VOLUME_INPUT).addEventListener('input', function() {
                notification_volume = this.value/100;
                document.getElementById(ID_NOTIFICATION_VOLUME).textContent = this.value;                
                updateBookmark();
            });
            document.getElementById(ID_START_TIMER).addEventListener('click', function() {
                if(! audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                start();
            });
            document.getElementById(ID_STOP_TIMER).addEventListener('click', function() {
                stop();
            });

            document.getElementById(ID_BREAK_BUTTON).addEventListener('click', handleBreakButton);
            document.getElementById(ID_WORK_BUTTON).addEventListener('click', handleWorkButton);
            
            updateFromParameters();
            document.getElementById(ID_START_TIMER).disabled = false;
            document.getElementById(ID_STOP_TIMER).disabled = true;            
            document.getElementById(ID_BREAK_BUTTON).disabled = true;
            document.getElementById(ID_WORK_BUTTON).disabled = true;
            console.log(work_interval_minutes, break_interval_minutes, notification_seconds, notification_volume);
            
        });
        
        function handleBreakButton() {
            timer_state = timer_states.BREAK;
            timer_seconds = 0;
            document.getElementById(ID_BREAK_BUTTON).disabled = true;
            document.getElementById(ID_WORK_BUTTON).disabled = false;
        }
        
        function handleWorkButton() {
            createStatisticsRow();

            timer_state = timer_states.WORK;
            timer_seconds = 0;
            updateTimer(ID_BREAK_TIMER, break_interval_minutes * 60);                
            document.getElementById(ID_BREAK_BUTTON).disabled = false;
            document.getElementById(ID_WORK_BUTTON).disabled = true;
        }
        
        function updateFromParameters() {
            const currentUrl = new URL(window.location.href);
            const urlParams = currentUrl.searchParams;
            function updateFromParameter(input_id, parameter, preset) {
                let element = document.getElementById(input_id);
                if (urlParams.has(parameter)) {
                    element.value = urlParams.get(parameter);    
                } else {
                    element.value = preset;
                }
                element.dispatchEvent(new Event('input'));
            }
            updateFromParameter(ID_WORK_INPUT, 'work', work_interval_minutes);
            updateFromParameter(ID_BREAK_INPUT, 'break', break_interval_minutes);
            updateFromParameter(ID_NOTIFICATION_INPUT, 'repetition', notification_seconds);
            updateFromParameter(ID_NOTIFICATION_VOLUME_INPUT, 'volume', notification_volume*100);
            
        }

        function start() {
            createStatisticsRow();        
            timer_seconds = 0;
            timer_state = timer_states.WORK;
            updateTimer(ID_BREAK_TIMER, break_interval_minutes * 60);
            document.getElementById(ID_START_TIMER).disabled = true;
            document.getElementById(ID_STOP_TIMER).disabled = false;            
            document.getElementById(ID_BREAK_BUTTON).disabled = false;
            document.getElementById(ID_WORK_BUTTON).disabled = true;
        }
        
        function handleTick() {
            function handleTimer(timer_id, timeout_seconds) {
                let time_left_seconds = timeout_seconds - timer_seconds;
                updateTimer(timer_id, time_left_seconds);
                if(time_left_seconds <= 0 && (time_left_seconds % notification_seconds == 0)) {
                    timerSignal();
                }                        
                timer_seconds = timer_seconds + 1;
            }
        
            switch(timer_state) {
                case timer_states.WORK:
                    updateStatisticsRow();                    
                    handleTimer(ID_WORK_TIMER, work_interval_minutes * 60);
                    break;                
                case timer_states.BREAK:
                    updateStatisticsRow();                    
                    handleTimer(ID_BREAK_TIMER, break_interval_minutes * 60);
                    break;
            }

        }
        function updateTimer(timer_id, timer) {
            let timerElement = document.getElementById(timer_id)
            let minutes = Math.floor(Math.abs(timer) / 60);
            let seconds = Math.abs(timer) % 60;
            let str = (timer >= 0 ? '' : '+') + String(minutes).padStart(1, '0') + "m" + String(seconds).padStart(2, '0') + "s";
            timerElement.textContent = str;
        }        
        function stop() {
            timer_state = timer_states.OFF;
            document.getElementById(ID_START_TIMER).disabled = false;
            document.getElementById(ID_STOP_TIMER).disabled = true;            
            document.getElementById(ID_BREAK_BUTTON).disabled = true;
            document.getElementById(ID_WORK_BUTTON).disabled = true;
            
        }

        async function timerSignal() {
            function beep(duration, frequency, volume) {
                let oscillator = audioContext.createOscillator();
                let gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                gainNode.gain.value = volume;
                oscillator.frequency.value = frequency;
                oscillator.type = "sine";

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration / 1000);
            }

            let freq = 3080;
            let duration = 100;
            let pause = 200;
            beep(duration, freq, notification_volume);
            await new Promise(resolve => setTimeout(resolve, pause));
            beep(duration, freq, notification_volume);
            await new Promise(resolve => setTimeout(resolve, pause));
            beep(duration, freq, notification_volume);
        }
        
        function createStatisticsRow() {
            function getCurrentTimeString() {
                var now = new Date();
                var hours = now.getHours();
                var minutes = now.getMinutes();
                minutes = minutes < 10 ? '0' + minutes : minutes;
                return hours + ':' + minutes;
            }        
            var table = document.getElementById(ID_STATISTICS_TABLE);
            var row = table.insertRow(1);

            row.insertCell(0).textContent = getCurrentTimeString();
            row.insertCell(1).textContent = "0m00s";
            row.insertCell(2).textContent = "0m00s";            
        }
        function updateStatisticsRow() {
            var table = document.getElementById(ID_STATISTICS_TABLE);
            var row = table.rows[1];
            var cell = null;
            switch(timer_state) {
                case timer_states.WORK:
                    cell = row.cells[1];                    
                    break;                
                case timer_states.BREAK:
                    cell = row.cells[2];            
                    break;
            }
            let minutes = Math.floor(Math.abs(timer_seconds) / 60);
            let seconds = Math.abs(timer_seconds) % 60;
            cell.textContent = String(minutes).padStart(1, '0') + "m" + String(seconds).padStart(2, '0') + "s";
        }


        function updateBookmark() {
            const currentUrl = new URL(window.location.href);
            const urlParams = currentUrl.searchParams;
            urlParams.set('work', document.getElementById(ID_WORK_INPUT).value);
            urlParams.set('break', document.getElementById(ID_BREAK_INPUT).value);
            urlParams.set('repetition', document.getElementById(ID_NOTIFICATION_INPUT).value);
            urlParams.set('volume', document.getElementById(ID_NOTIFICATION_VOLUME_INPUT).value);
            document.getElementById(ID_BOOKMARK).href = currentUrl.toString();
        }
        

    </script>
</body>
</html>
